<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts app</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        input, button, textarea {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
            width: auto;
        }
        button:hover {
            background-color: #0056b3;
        }
        .post-item {
            background-color: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .welcome {
            background-color: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            max-width: 300px;
        }
        .notification.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .edit-form {
            margin-top: 10px;
            display: none;
        }
        .edit-form.show {
            display: block;
        }
    </style>
    <script>
        let currentUser = "";
        const BACKEND_URL = "http://localhost:8080";

        document.addEventListener('DOMContentLoaded', function() {
            fetchPosts();
        });

        function setUser() {
            const usernameInput = document.getElementById("username");
            const username = usernameInput.value.trim();

            if (username === "") {
                alert("Please enter a username");
                return;
            }

            currentUser = username;
            document.getElementById("userSection").style.display = "none";
            document.getElementById("appSection").style.display = "block";
            document.getElementById("welcomeMessage").textContent = `Welcome, ${currentUser}!`;

            // Connect to WebSocket
            connectWebSocket();
        }

        function connectWebSocket() {
            // Create a new SockJS connection to the backend WebSocket endpoint
            const socket = new SockJS(`${BACKEND_URL}/ws`);
            // wraps the SockJS connection with STOMP
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                console.log('Connected to WebSocket');
                // Subscribe to the topic for article notifications
                stompClient.subscribe('/topic/posts', function (notification) {
                    const postData = JSON.parse(notification.body);
                    showNotification(postData);
                });
            });
        }

        function showNotification(post) {
            if (!post || typeof post !== 'object') {
                console.error("Invalid notification data: not an object", post);
                return;
            }

            const notification = document.getElementById("notification");
            const date = new Date(post.Date).toLocaleString();

            notification.innerHTML = `
                <strong>New post by ${post.user}</strong><br>
                Topic: ${post.topicName}<br>
                Content: ${post.text}<br>
                Time: ${post.date}
            `;
            notification.classList.add("show");

            fetchPosts();

            // Hide notification after 5 seconds
            setTimeout(() => {
                notification.classList.remove("show");
            }, 5000);
        }

        function fetchPosts() {
            fetch(`${BACKEND_URL}/posts`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch posts.");
                    }
                    return response.json();
                })
                .then(data => {
                    const postsDiv = document.getElementById("posts");
                    postsDiv.innerHTML = "";
                    if (data.length === 0) {
                        postsDiv.innerHTML = "<p>No posts found</p>";
                    } else {
                        data.forEach(post => {
                            const postDiv = document.createElement("div");
                            postDiv.className = "post-item";
                            postDiv.innerHTML = `
                                <strong>[${post.id}] ${post.user} on ${post.topicName} at ${new Date(post.date).toLocaleString()}</strong>
                                <p>${post.text}</p>
                                <button onclick="toggleEditForm(${post.id})">Edit</button>
                                <div id="edit-form-${post.id}" class="edit-form" style="display: none;">
                                    <input type="text" id="edit-topic-${post.id}" value="${post.topicName}" placeholder="Topic Name">
                                    <textarea id="edit-text-${post.id}">${post.text}</textarea>
                                    <button onclick="submitEdit(${post.id})">Save</button>
                                    <button onclick="toggleEditForm(${post.id})">Cancel</button>
                                </div>
                            `;
                            postsDiv.appendChild(postDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Error fetching posts: " + error.message);
                });
        }

        function toggleEditForm(postId) {
            const editForm = document.getElementById(`edit-form-${postId}`);
            if (editForm.style.display === "none" || !editForm.style.display) {
                editForm.style.display = "block";
            } else {
                editForm.style.display = "none";
            }
        }

        function submitEdit(postId) {
            const newText = document.getElementById(`edit-text-${postId}`).value.trim();
            const newTopic = document.getElementById(`edit-topic-${postId}`).value.trim();
            modifyPost(postId, newText, newTopic);
        }

        function modifyPost(postId, modifiedText, topicName) {
            const formData = new URLSearchParams();
            formData.append('id', postId);
            formData.append('user', currentUser);
            formData.append('topicName', topicName);
            formData.append('text', modifiedText);

            fetch(`${BACKEND_URL}/posts`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || "Failed to modify post.");
                    });
                }
                return response.json();
            })
            .then(data => {
                alert("Post modified successfully!");
                toggleEditForm(postId);
                fetchPosts();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error modifying post: " + error.message);
            });
        }

        function addPost() {
            const topicName = document.getElementById("topicName").value.trim();
            const postText = document.getElementById("postText").value.trim();
            
            if (!currentUser) {
                alert("Please set your username first.");
                return;
            }
            
            if (!topicName || !postText) {
                alert("Please enter both topic name and post text.");
                return;
            }

            const formData = new URLSearchParams();
            formData.append('user', currentUser);
            formData.append('topicName', topicName);
            formData.append('text', postText);

            fetch(`${BACKEND_URL}/posts`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || "Failed to add post.");
                    });
                }
                return response.json();
            })
            .then(data => {
                alert("Post added successfully!");
                // Clear the form
                document.getElementById("topicName").value = "";
                document.getElementById("postText").value = "";
                // Refresh the posts list
                fetchPosts();
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error adding post: " + error.message);
            });
        }
    </script>
</head>
<body>
<div id="userSection" class="container">
    <h1>Welcome to the Posts App</h1>
    <label for="username">Enter your username:</label>
    <input type="text" id="username" required>
    <button onclick="setUser()">Start</button>
</div>

<div id="appSection" style="display: none;">
    <div class="welcome">
        <h1 id="welcomeMessage"></h1>
    </div>

    <div id="notification" class="notification"></div>

    <div class="container">
        <h2>Posts</h2>
        <div id="posts"></div>
    </div>

    <div class="container">
        <h2>Add New Post</h2>
        <label for="topicName">Topic Name:</label>
        <input type="text" id="topicName" required>
        <label for="postText">Post Content:</label>
        <textarea id="postText" required></textarea>
        <button onclick="addPost()">Add Post</button>
    </div>
</div>
</body>
</html>