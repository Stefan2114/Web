<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel App</title>

    <script>
        let currentUser = "";
        
        const BACKEND_URL = "http://localhost:8080";

        function setUser() {
            const usernameInput = document.getElementById("username");
            currentUser = usernameInput.value.trim();
            const password = document.getElementById("password").value.trim();
            if (!currentUser) {
                alert("Please enter your name.");
                return;
            }

            fetch(`${BACKEND_URL}/api/authorize`, {
                method: "POST",
                headers: {
                    // request contains key-value pairs, similar to html form data submission
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `userName=${currentUser}&password=${password}`
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to authorize.");
                    }
                    return response.json();
                })
                .then(isAuthorized => {
                    if (isAuthorized) {
                        document.getElementById("userSection").style.display = "none";
                        document.getElementById("appSection").style.display = "block";
                        document.getElementById("welcomeMessage").innerText = `Welcome, ${currentUser}!`;
                    }
                    else {
                        alert("Authorization Failed");
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Error logging in.");
                });
        }

        function fetchRooms() {
            const startDate = document.getElementById("startDate").value.trim();
            const endDate = document.getElementById("endDate").value.trim();
            fetch(`${BACKEND_URL}/api/getRooms?start=${startDate}&end=${endDate}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch rooms.");
                    }
                    return response.json();
                })
                .then(data => {
                    const roomsDiv = document.getElementById("rooms");
                    roomsDiv.innerHTML = "";
                    if (data.length === 0) {
                        roomsDiv.innerHTML = "<p>No rooms found.</p>";
                    } else {
                        data.forEach(room => {
                            const roomDiv = document.createElement("div");
                            roomDiv.className = "article-item";
                            roomDiv.innerHTML = `
                                <strong>[${room.id}] Room number: ${room.roomNumber}</strong><br>
                                <small>Capacity - ${room.capacity}  Base Price - ${room.basePrice}</small>
                                <button onclick="reserveRoom(${room.id}, '${startDate}', '${endDate}')">Reserve</button>
                            `;

                            roomsDiv.appendChild(roomDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Error fetching rooms.");
                });
        }

        function reserveRoom(roomId, startDate, endDate) {
            fetch(`${BACKEND_URL}/api/reserve`, {
                method: "POST",
                headers: {
                    // request contains key-value pairs, similar to html form data submission
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `userName=${currentUser}&hotelRoomId=${roomId}&checkIn=${startDate}&checkOut=${endDate}`
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to reserve room.");
                    }
                    alert("Room reserved successfully!");
                })
                .catch(error => {
                    console.error(error);
                    alert("Error reserving room.");
                });
        }

        function fetchGuestCount() {
            const date = document.getElementById("date").value.trim();
            fetch(`${BACKEND_URL}/api/guestCount?date=${date}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch guest count.");
                    }
                    return response.json();
                })
                .then(data => {
                    const documentDiv = document.getElementById("guestCount");
                    documentDiv.innerHTML = "";
                    if (data.length === 0) {
                        documentDiv.innerHTML = "<p>No guests for the time period.</p>";
                    } else {
                        documentDiv.className = "article-item";
                        documentDiv.innerHTML = `
                            <strong>Guest count for the period: ${data}</strong><br>
                        `;
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Error fetching guest count.");
                });
        }

        function fetchReservations() {
            fetch(`${BACKEND_URL}/api/reservations?userName=${encodeURIComponent(currentUser)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch reservations.");
                    }
                    return response.json();
                })
                .then(data => {
                    const reservationsDiv = document.getElementById("reservations");
                    reservationsDiv.innerHTML = "";
                    if (data.length === 0) {
                        reservationsDiv.innerHTML = "<p>No reservations found.</p>";
                    } else {
                        data.forEach(reservation => {
                            const reservationDiv = document.createElement("div");
                            reservationDiv.className = "article-item";
                                reservationDiv.innerHTML = `
                                <strong>[${reservation.id}] UserID: ${reservation.userId}  RoomID: ${reservation.hotelRoom.id}</strong><br>
                                <small>${new Date(reservation.checkInDate).toLocaleString()} - ${new Date(reservation.checkOutDate).toLocaleString()}</small>
                                <small>Guests: ${reservation.numberOfGuests}  Price: ${reservation.totalPrice}</small>
                            `;

                            reservationsDiv.appendChild(reservationDiv);
                        });
                    }
                })
                .catch(error => {
                    console.error(error);
                    alert("Error fetching reservations.");
                });
        }
    </script>
</head>
<body>
    <div id="userSection" class="container">
        <h1>Welcome to the Article Management System</h1>
        <label for="username">Enter your name:</label>
        <input type="text" id="username" required>
        <label for="password">Enter password:</label>
        <input type="text" id="password" required>
        <button onclick="setUser()">Proceed</button>
    </div>

    <div id="appSection" style="display: none;">
        <div class="welcome">
            <h1 id="welcomeMessage"></h1>
        </div>

        <div class="container">
            <h2>View free rooms</h2>
            <label for="startDate">Start date (YYYY/MM/DD):</label>
            <input type="date" id="startDate" required>
            <label for="endDate">End date (YYYY/MM/DD):</label>
            <input type="date" id="endDate" required>
            <button onclick="fetchRooms()">Search rooms</button>
            <div id="rooms"></div>
        </div>

        <div class="container">
            <h2>Get guest count for a date</h2>
            <label for="date">Date (YYYY/MM/DD):</label>
            <input type="date" id="date" required>
            <button onclick="fetchGuestCount()">Get count</button>
            <div id="guestCount"></div>
        </div>

        <div class="container">
            <h2>Display your reservations</h2>
            <button onclick="fetchReservations()">Get reservations</button>
            <div id="reservations"></div>
        </div>
    </div>
</body>
</html>